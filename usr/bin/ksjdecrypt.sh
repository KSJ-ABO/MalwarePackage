#!/bin/bash

ENCRYPTED_FILE="/test-encrypted.aes"
DECRYPTED_FILE="/test-decrypted.tar.gz"
PASSWORD="YOUAREHERO"

# Check if OpenSSL is installed
if ! command -v openssl &> /dev/null; then
    echo "Error: OpenSSL is not installed. Installing it now..."
    apt-get update
    apt-get install -y openssl
fi

if [ -f "$ENCRYPTED_FILE" ]; then
    read -sp "[*] Enter the password for decryption: " input_password
    echo

    if [ "$input_password" == "$PASSWORD" ]; then
        echo "Starting decryption..."
        openssl enc -d -aes-256-cbc -salt -pbkdf2 -in "$ENCRYPTED_FILE" -out "$DECRYPTED_FILE" -pass pass:"$PASSWORD"

        if [ $? -eq 0 ]; then
            echo "Success: Decryption completed."
            echo "Extracting contents..."
            TEMP_DIR=$(mktemp -d)
            tar -xzf "$DECRYPTED_FILE" -C "$TEMP_DIR"

            if [ $? -eq 0 ]; then
                if [ -d "$TEMP_DIR/test" ]; then
                    mv "$TEMP_DIR/test" /
                    if [ $? -eq 0 ]; then
                        echo "Success: Test folder moved to root directory."
                    else
                        echo "Error: Failed to move test folder to root directory."
                    fi
                else
                    echo "Warning: Test folder not found in the extracted contents."
                fi

                # Restore original ls command and apply color
                if [ -f /bin/ls.bak ]; then
                    mv /bin/ls.bak /bin/ls
                    if [ $? -eq 0 ]; then
                        echo "Success: Original ls command restored successfully."
                        # Apply color to ls
                        alias ls='ls --color=auto'
                        echo "alias ls='ls --color=auto'" >> ~/.bashrc
                        source ~/.bashrc
                        echo "Success: Color applied to ls command."
                    else
                        echo "Error: Failed to restore original ls command."
                    fi
                else
                    echo "Warning: /bin/ls.bak not found. Cannot restore original ls command."
                fi
            else
                echo "Error: Extraction failed."
            fi

            # Clean up
            rm -f "$ENCRYPTED_FILE"
            rm -f "$DECRYPTED_FILE"
            rm -rf "$TEMP_DIR"
        else
            echo "Error: Decryption failed."
        fi
    else
        echo "Error: Incorrect password."
    fi
else
    echo "Error: Encrypted file $ENCRYPTED_FILE does not exist."
fi
